!function(t,i,e){"use strict";function o(t,i){var e;if(void 0===t)return i;for(e in i)i.hasOwnProperty(e)&&t.hasOwnProperty(e)===!1&&(t[e]=i[e]);return t}function s(t,i,e){return this.init(t,i,e)}function n(t,i){this.darkroom=t,this.options=o(i,this.defaults),this.initialize()}function a(t){this.element=t,this.actionsElement=t.querySelector(".darkroom-toolbar-actions")}function h(t){this.element=t}function r(t){this.element=t}t.Darkroom=s,s.plugins=[],n.prototype={defaults:{},initialize:function(){}},n.extend=function(t){var i,e=this;i=t&&t.hasOwnProperty("constructor")?t.constructor:function(){return e.apply(this,arguments)},o(i,e);var s=function(){this.constructor=i};return s.prototype=e.prototype,i.prototype=new s,t&&o(i.prototype,t),i.__super__=e.prototype,i},s.Plugin=n,a.prototype.createButtonGroup=function(t){var e=i.createElement("li");return e.className="darkroom-button-group",this.actionsElement.appendChild(e),new h(e)},h.prototype.createButton=function(t,e){var s={image:"help",type:"default",group:"default",hide:!1,disabled:!1};void 0!==e&&(s.label=e),t=o(t,s);var n=i.createElement("button");n.className="darkroom-button darkroom-button-"+t.type;var a='<i class="darkroom-icon-'+t.image+'"></i>';void 0!==e&&(a+="<span>"+t.label+"</span>"),n.innerHTML=a,this.element.appendChild(n);var n=new r(n);return n.hide(t.hide),n.disable(t.disabled),n},r.prototype={addEventListener:function(t,i){var e=this.element;e.addEventListener?e.addEventListener(t,i):e.attachEvent&&e.attachEvent("on"+t,i)},active:function(t){t?this.element.classList.add("darkroom-button-active"):this.element.classList.remove("darkroom-button-active")},hide:function(t){t?this.element.classList.add("darkroom-button-hidden"):this.element.classList.remove("darkroom-button-hidden")},disable:function(t){this.element.disabled=t?!0:!1}};var c=e.util.createClass(e.Canvas,{});s.prototype={defaults:{minWidth:null,minHeight:null,maxWidth:null,maxHeight:null,backgroundColor:"",plugins:{},init:function(){},covertToMainCanvasInqua:null},addEventListener:function(t,i){var e=this.canvas.getElement();e.addEventListener?e.addEventListener(t,i):e.attachEvent&&e.attachEvent("on"+t,i)},dispatchEvent:function(t){var e=i.createEvent("Event");e.initEvent(t,!0,!0),this.canvas.getElement().dispatchEvent(e)},init:function(t,e,n){var a=this;if(this.options=o(e,this.defaults),"string"==typeof t&&(t=i.querySelector(t)),null!==t){var n=n||s.plugins,h=new Image;h.onload=function(){a.createFabricImage(t).initDOM(t).initPlugins(n),a.options.init.bind(a).call()},h.src=t.src}},initDOM:function(t){var e=i.createElement("div");e.className="darkroom-toolbar",e.innerHTML='<ul class="darkroom-toolbar-actions"></ul>';var o=i.createElement("canvas"),s=i.createElement("div");return s.className="darkroom-image-container",s.appendChild(o),this.container=i.createElement("div"),this.container.className="darkroom-container",this.container.appendChild(e),this.container.appendChild(s),t.parentNode.replaceChild(this.container,t),this.toolbar=new a(e),this.canvas=new c(o,{selection:!1,backgroundColor:this.options.backgroundColor}),this.canvas.setWidth(this.image.getWidth()),this.canvas.setHeight(this.image.getHeight()),this.canvas.add(this.image),this.canvas.centerObject(this.image),this.image.setCoords(),this},createFabricImage:function(t){var i=t.width,o=t.height,s=1,n=1,a=1,h=1;null!==this.options.maxWidth&&this.options.maxWidth<i&&(a=this.options.maxWidth/i),null!==this.options.maxHeight&&this.options.maxHeight<o&&(h=this.options.maxHeight/o),s=Math.min(a,h),a=1,h=1,null!==this.options.minWidth&&this.options.minWidth>i&&(a=this.options.minWidth/i),null!==this.options.minHeight&&this.options.minHeight>o&&(h=this.options.minHeight/o),n=Math.max(a,h);var r=n*s;return i*=r,o*=r,this.image=new e.Image(t,{selectable:!0,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),this.image.setScaleX(r),this.image.setScaleY(r),this},initPlugins:function(t){this.plugins={};for(var i in t){var e=t[i],o=this.options.plugins[i];o!==!1&&t.hasOwnProperty(i)&&(this.plugins[i]=new e(this,o))}},getPlugin:function(t){return this.plugins[t]},selfDestroy:function(){var t=this.container,i=new Image;i.onload=function(){t.parentNode.replaceChild(i,t)},i.src=this.snapshotImage()},snapshotImage:function(){return this.image.toDataURL()},covertToMainCanvasInqua:function(){this.options.covertToMainCanvasInqua.call(this)}}}(window,window.document,fabric),!function(t,i,e,o){"use strict";var s=o.util.createClass(o.Rect,{_render:function(t){this.callSuper("_render",t);var i=(t.canvas,7),e=this.flipX?-1:1,o=this.flipY?-1:1,s=e/this.scaleX,n=o/this.scaleY;t.scale(s,n),t.fillStyle="rgba(0, 0, 0, 0.5)",this._renderOverlay(t),void 0!==t.setLineDash?t.setLineDash([i,i]):void 0!==t.mozDash&&(t.mozDash=[i,i]),t.strokeStyle="rgba(0, 0, 0, 0.2)",this._renderBorders(t),this._renderGrid(t),t.lineDashOffset=i,t.strokeStyle="rgba(255, 255, 255, 0.4)",this._renderBorders(t),this._renderGrid(t),t.scale(1/s,1/n)},_renderOverlay:function(t){var i=t.canvas,e=0,o=Math.ceil(-this.getWidth()/2-this.getLeft()),s=Math.ceil(-this.getWidth()/2),n=Math.ceil(this.getWidth()/2),a=Math.ceil(this.getWidth()/2+(i.width-this.getWidth()-this.getLeft())),h=Math.ceil(-this.getHeight()/2-this.getTop()),r=Math.ceil(-this.getHeight()/2),c=Math.ceil(this.getHeight()/2),d=Math.ceil(this.getHeight()/2+(i.height-this.getHeight()-this.getTop()));t.fillRect(o,h,a-o,r-h+e),t.fillRect(o,r,s-o,c-r+e),t.fillRect(n,r,a-n,c-r+e),t.fillRect(o,c,a-o,d-c)},_renderBorders:function(t){t.beginPath(),t.moveTo(-this.getWidth()/2,-this.getHeight()/2),t.lineTo(this.getWidth()/2,-this.getHeight()/2),t.lineTo(this.getWidth()/2,this.getHeight()/2),t.lineTo(-this.getWidth()/2,this.getHeight()/2),t.lineTo(-this.getWidth()/2,-this.getHeight()/2),t.stroke()},_renderGrid:function(t){t.beginPath(),t.moveTo(-this.getWidth()/2+1/3*this.getWidth(),-this.getHeight()/2),t.lineTo(-this.getWidth()/2+1/3*this.getWidth(),this.getHeight()/2),t.stroke(),t.beginPath(),t.moveTo(-this.getWidth()/2+2/3*this.getWidth(),-this.getHeight()/2),t.lineTo(-this.getWidth()/2+2/3*this.getWidth(),this.getHeight()/2),t.stroke(),t.beginPath(),t.moveTo(-this.getWidth()/2,-this.getHeight()/2+1/3*this.getHeight()),t.lineTo(this.getWidth()/2,-this.getHeight()/2+1/3*this.getHeight()),t.stroke(),t.beginPath(),t.moveTo(-this.getWidth()/2,-this.getHeight()/2+2/3*this.getHeight()),t.lineTo(this.getWidth()/2,-this.getHeight()/2+2/3*this.getHeight()),t.stroke()}});e.plugins.crop=e.Plugin.extend({startX:null,startY:null,isKeyCroping:!1,isKeyLeft:!1,isKeyUp:!1,defaults:{minHeight:1,minWidth:1,ratio:null,quickCropKey:!1},initialize:function(){var t=this.darkroom.toolbar.createButtonGroup();this.cropButton=t.createButton({image:"crop"}," Cắt hình"),this.okButton=t.createButton({image:"accept",type:"success",hide:!0}," Ok"),this.cancelButton=t.createButton({image:"cancel",type:"danger",hide:!0}," Hủy"),this.cropButton.addEventListener("click",this.toggleCrop.bind(this)),this.okButton.addEventListener("click",this.cropCurrentZone.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.darkroom.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.darkroom.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.darkroom.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.darkroom.canvas.on("object:moving",this.onObjectMoving.bind(this)),this.darkroom.canvas.on("object:scaling",this.onObjectScaling.bind(this)),o.util.addListener(o.document,"keydown",this.onKeyDown.bind(this)),o.util.addListener(o.document,"keyup",this.onKeyUp.bind(this)),this.darkroom.addEventListener("image:change",this.releaseFocus.bind(this))},onObjectMoving:function(t){if(this.hasFocus()){var i=t.target;if(i===this.cropZone){var e=this.darkroom.canvas,o=i.getLeft(),s=i.getTop(),n=i.getWidth(),a=i.getHeight(),h=e.getWidth()-n,r=e.getHeight()-a;0>o&&i.set("left",0),0>s&&i.set("top",0),o>h&&i.set("left",h),s>r&&i.set("top",r),this.darkroom.dispatchEvent("crop:update")}}},onObjectScaling:function(t){if(this.hasFocus()){var i=!1,e=t.target;if(e===this.cropZone){var o=this.darkroom.canvas,s=o.getPointer(t.e),n=(s.x,s.y,e.getLeft()),a=e.getTop(),h=e.getLeft()+e.getWidth(),r=e.getTop()+e.getHeight();if(null!==this.options.ratio&&(0>n||h>o.getWidth()||0>a||r>o.getHeight())&&(i=!0),0>n||h>o.getWidth()||i){var c=this.lastScaleX||1;e.setScaleX(c)}if(0>n&&e.setLeft(0),0>a||r>o.getHeight()||i){var d=this.lastScaleY||1;e.setScaleY(d)}0>a&&e.setTop(0),e.getWidth()<this.options.minWidth&&e.scaleToWidth(this.options.minWidth),e.getHeight()<this.options.minHeight&&e.scaleToHeight(this.options.minHeight),this.lastScaleX=e.getScaleX(),this.lastScaleY=e.getScaleY(),this.darkroom.dispatchEvent("crop:update")}}},onMouseDown:function(t){if(this.hasFocus()){var i=this.darkroom.canvas;i.calcOffset();var e=i.getPointer(t.e),s=e.x,n=e.y,a=new o.Point(s,n),h=i.getActiveObject();h===this.cropZone||this.cropZone.containsPoint(a)||(i.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.startX=s,this.startY=n)}},onMouseMove:function(t){if(this.isKeyCroping)return this.onMouseMoveKeyCrop(t);if(null!==this.startX&&null!==this.startY){var i=this.darkroom.canvas,e=i.getPointer(t.e),o=e.x,s=e.y;this._renderCropZone(this.startX,this.startY,o,s)}},onMouseMoveKeyCrop:function(t){var i=this.darkroom.canvas,e=this.cropZone,o=i.getPointer(t.e),s=o.x,n=o.y;e.left&&e.top||(e.setTop(n),e.setLeft(s)),this.isKeyLeft=s<e.left+e.width/2,this.isKeyUp=n<e.top+e.height/2,this._renderCropZone(Math.min(e.left,s),Math.min(e.top,n),Math.max(e.left+e.width,s),Math.max(e.top+e.height,n))},onMouseUp:function(t){if(null!==this.startX&&null!==this.startY){var i=this.darkroom.canvas;this.cropZone.setCoords(),i.setActiveObject(this.cropZone),i.calcOffset(),this.startX=null,this.startY=null}},onKeyDown:function(t){!1===this.options.quickCropKey||t.keyCode!==this.options.quickCropKey||this.isKeyCroping||(this.isKeyCroping=!0,this.darkroom.canvas.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.cropZone.setTop(0),this.cropZone.setLeft(0))},onKeyUp:function(t){!1!==this.options.quickCropKey&&t.keyCode===this.options.quickCropKey&&this.isKeyCroping&&(this.isKeyCroping=!1,this.startX=1,this.startY=1,this.onMouseUp())},selectZone:function(t,i,e,o,s){this.hasFocus()||this.requireFocus(),s?this.cropZone.set({left:t,top:i,width:e,height:o}):this._renderCropZone(t,i,t+e,i+o);var n=this.darkroom.canvas;n.bringToFront(this.cropZone),this.cropZone.setCoords(),n.setActiveObject(this.cropZone),n.calcOffset(),this.darkroom.dispatchEvent("crop:update")},toggleCrop:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},cropCurrentZone:function(){if(this.hasFocus()&&!(this.cropZone.width<1&&this.cropZone.height<1)){var t=this,i=this.darkroom,e=i.canvas;this.cropZone.visible=!1;var s=new Image;s.onload=function(){if(!(this.height<1||this.width<1)){var s=new o.Image(this,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),n=(this.width,this.height);if(e.setHeight(n),t.darkroom.image.remove(),t.darkroom.image=s,e.getWidth()<s.width){var a=e.getWidth()/s.width;s.scale(a>=.5?a-.4:a)}e.add(s),i.dispatchEvent("image:change")}},s.src=e.toDataURL({left:this.cropZone.getLeft()+5,top:this.cropZone.getTop()+5,width:this.cropZone.getWidth()-10,height:this.cropZone.getHeight()-10,multiplier:5})}},hasFocus:function(){return void 0!==this.cropZone},requireFocus:function(){this.cropZone=new s({fill:"transparent",hasBorders:!1,originX:"left",originY:"top",cornerColor:"#444",cornerSize:8,transparentCorners:!1,lockRotation:!0,hasRotatingPoint:!1}),null!==this.options.ratio&&this.cropZone.set("lockUniScaling",!0),this.darkroom.canvas.add(this.cropZone),this.darkroom.canvas.defaultCursor="crosshair",this.cropButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1)},releaseFocus:function(){void 0!==this.cropZone&&(this.cropZone.remove(),this.cropZone=void 0,this.cropButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.darkroom.canvas.defaultCursor="default",this.darkroom.dispatchEvent("crop:update"))},_renderCropZone:function(t,i,e,o){var s=this.darkroom.canvas,n=e>t,a=!n,h=o>i,r=!h,c=Math.min(+this.options.minWidth,s.getWidth()),d=Math.min(+this.options.minHeight,s.getHeight()),g=Math.min(t,e),l=Math.max(t,e),u=Math.min(i,o),p=Math.max(i,o);g=Math.max(0,g),l=Math.min(s.getWidth(),l),u=Math.max(0,u),p=Math.min(s.getHeight(),p),c>l-g&&(n?l=g+c:g=l-c),d>p-u&&(h?p=u+d:u=p-d),0>g&&(l+=Math.abs(g),g=0),l>s.getWidth()&&(g-=l-s.getWidth(),l=s.getWidth()),0>u&&(p+=Math.abs(u),u=0),p>s.getHeight()&&(u-=p-s.getHeight(),p=s.getHeight());var m=l-g,v=p-u,f=m/v;if(this.options.ratio&&+this.options.ratio!==f){var k=+this.options.ratio;if(this.isKeyCroping&&(a=this.isKeyLeft,r=this.isKeyUp),k>f){var b=v*k;a&&(g-=b-m),m=b}else if(f>k){var y=v/(k*v/m);r&&(u-=y-v),v=y}if(0>g&&(g=0),0>u&&(u=0),g+m>s.getWidth()){var b=s.getWidth()-g;v=b*v/m,m=b,r&&(u=i-v)}if(u+v>s.getHeight()){var y=s.getHeight()-u;m=m*y/v,v=y,a&&(g=t-m)}}this.cropZone.left=g,this.cropZone.top=u,this.cropZone.width=m,this.cropZone.height=v,this.darkroom.canvas.bringToFront(this.cropZone),this.darkroom.dispatchEvent("crop:update")}})}(window,document,Darkroom,fabric),function(t,i,e,o){"use strict";e.plugins.history=e.Plugin.extend({initialize:function(){this._initButtons(),this.backHistoryStack=[],this.forwardHistoryStack=[],this._snapshotImage(),this.darkroom.addEventListener("image:change",this._onImageChange.bind(this))},goBack:function(){0!==this.backHistoryStack.length&&(this.forwardHistoryStack.push(this.currentImage),this.currentImage=this.backHistoryStack.pop(),this._applyImage(this.currentImage),this._updateButtons(),this.darkroom.dispatchEvent("history:navigate"))},goForward:function(){0!==this.forwardHistoryStack.length&&(this.backHistoryStack.push(this.currentImage),this.currentImage=this.forwardHistoryStack.pop(),this._applyImage(this.currentImage),this._updateButtons(),this.darkroom.dispatchEvent("history:navigate"))},_initButtons:function(){var t=this.darkroom.toolbar.createButtonGroup();return this.backButton=t.createButton({image:"back",disabled:!0}),this.forwardButton=t.createButton({image:"forward",disabled:!0}),this.backButton.addEventListener("click",this.goBack.bind(this)),this.forwardButton.addEventListener("click",this.goForward.bind(this)),this},_updateButtons:function(){this.backButton.disable(0===this.backHistoryStack.length),this.forwardButton.disable(0===this.forwardHistoryStack.length)},_snapshotImage:function(){var t=new Image;t.src=this.darkroom.snapshotImage(),this.currentImage=t},_onImageChange:function(){this.backHistoryStack.push(this.currentImage),this._snapshotImage(),this.forwardHistoryStack.length=0,this._updateButtons()},_applyImage:function(t){var i=this.darkroom.canvas,e=new o.Image(t,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1});i.setWidth(t.width),i.setHeight(t.height),this.darkroom.image.remove(),this.darkroom.image=e,i.add(e)}})}(window,document,Darkroom,fabric),function(t,i,e,o){"use strict";e.plugins.rotate=e.Plugin.extend({initialize:function(){var t=this.darkroom.toolbar.createButtonGroup();this.leftButton=t.createButton({image:"rotate-left"}),this.rightButton=t.createButton({image:"rotate-right"}),this.leftButton.addEventListener("click",this.rotateLeft.bind(this)),this.rightButton.addEventListener("click",this.rotateRight.bind(this))},rotateLeft:function(){this.rotate(-90)},rotateRight:function(){this.rotate(90)},rotate:function(t){var i=this.darkroom,e=i.canvas,o=i.image;t=(o.getAngle()+t)%360;var s,n;n=Math.abs(o.getWidth()*Math.sin(t*Math.PI/180))+Math.abs(o.getHeight()*Math.cos(t*Math.PI/180)),s=Math.abs(o.getHeight()*Math.sin(t*Math.PI/180))+Math.abs(o.getWidth()*Math.cos(t*Math.PI/180)),e.setWidth(s),e.setHeight(n),o.rotate(t),e.centerObject(o),o.setCoords(),e.renderAll(),i.dispatchEvent("image:change")}})}(window,document,Darkroom,fabric),function(t,i,e){"use strict";e.plugins.save=e.Plugin.extend({defaults:{convertToCanvasInqua:function(){this.darkroom.covertToMainCanvasInqua()}},initialize:function(){var t=this.darkroom.toolbar.createButtonGroup();this.saveToMainCanvas=t.createButton({image:""},"Chuyển hình vào sản phẩm"),this.saveToMainCanvas.addEventListener("click",this.options.convertToCanvasInqua.bind(this))}})}(window,document,Darkroom);