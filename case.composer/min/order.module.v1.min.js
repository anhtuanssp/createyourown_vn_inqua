!function(e,t,n,i){CP.OrderController=function(e,t){this.checkOutStep1=null,this.checkOutStep2=null,this.checkOutStep3=null,this._page=[],this.isLogin=e.islogin,this.$el=null,this.$step1Wrapper=null,this.$step2Wrapper=null,this.$step3Wrapper=null,this.orderService=new CP.OrdersSerice,this.orderModule=t,this.orderThumb=null,this.viewPath="js/module/order.module.v1/view/template.html"},CP.OrderController.prototype.init=function(t){var n=this;this.checkOutStep1=new CP.OrderStep1Module(this),this.checkOutStep2=new CP.OrderStep2Module(this),this.checkOutStep3=new CP.OrderStep3Module(this),e.get(this.viewPath,function(i){var a=e(i).html(),r=Handlebars.compile(a);n.$el=e(r()),n.$step1Wrapper=n.$el.find(".step1"),n.$step2Wrapper=n.$el.find(".step2"),n.$step3Wrapper=n.$el.find(".step3"),n.checkOutStep1.init(n.renderStep1Success.bind(n)),t.call(this)})},CP.OrderController.prototype.renderStep1Success=function(){this.renderHinhThietKe(),this.$step1Wrapper.append(this.checkOutStep1.getElement()),this._page.push(this.checkOutStep1)},CP.OrderController.prototype.renderStep2Success=function(){this.checkOutStep2.$tennguoinhan.val(this.checkOutStep1.$inputName.val()),this.checkOutStep2.$phonenguoinhan.val(this.checkOutStep1.$inputPhone.val()),this.$step2Wrapper.append(this.checkOutStep2.getElement()),this._page.push(this.checkOutStep2),this.showCurrentPage()},CP.OrderController.prototype.renderStep3Success=function(){this.$step3Wrapper.append(this.checkOutStep3.getElement()),this._page.push(this.checkOutStep3),this.showCurrentPage(),this.orderModule.firstRender=!1},CP.OrderController.prototype.getElement=function(){return this.$el},CP.OrderController.prototype.showCurrentPage=function(){_.each(this._page,function(e,t,n){e.hide()}),this._page[this._page.length-1].show()},CP.OrderController.prototype.goBack=function(){_.each(this._page,function(e,t,n){e.hide()}),this._page.pop(),this._page[this._page.length-1].show()},CP.OrderController.prototype.nextToStep2=function(){this.checkOutStep2.init(this.renderStep2Success.bind(this))},CP.OrderController.prototype.backHandle=function(){this.goBack()},CP.OrderController.prototype.renderHinhThietKe=function(){this.fireEvent("RENDER_HINH_THIET_KE",!0)},CP.OrderController.prototype.submitOrderAndNextToStep3=function(){this.checkOutStep3.init(this.renderStep3Success.bind(this))},CP.OrderController.prototype.orderNow=function(){var t=this.checkOutStep1.getValue(),n=this.checkOutStep2.getValue(),i=e.extend(t,n);i.id_product=this.orderModule.dashboardCallback.rightModule.mainCanvas.getIdProduct(),i.hasBack=this.orderModule.dashboardCallback.rightModule.mainCanvas.hasBack,i.hasLayerCircle=this.orderModule.dashboardCallback.rightModule.mainCanvas.hasLayerCircle,i.is_layerCircle=this.orderModule.dashboardCallback.rightModule.mainCanvas.is_layerCircle,i.thumb="",i.is_sharing&&(i.user_json=JSON.stringify(this.orderModule.dashboardCallback.rightModule.mainCanvas.getItemFromCanvas())),this.orderService.param.data=i;var a=this.orderService.create(),r=this;a.done(function(e){r.orderThumb=e.thumb,r.checkOutStep3.updateStatus(e.status)})},CP.OrderController.prototype.shareFacebook=function(){var e=n.URL,t=new CP.FacebookService,i=this;t.checkLogin(function(){t.shareAMessage(e,MYLIB.IMAGEHOST+i.orderThumb)},function(){t.loginFacebook(function(){t.shareAMessage(e,MYLIB.IMAGEHOST+i.orderThumb)})},function(){t.loginFacebook(function(){t.shareAMessage(e,MYLIB.IMAGEHOST+i.orderThumb)})})},MYLIB.mixin(CP.OrderController,MYLIB.Event.ObserverMixin)}(jQuery,window,document),function(e,t,n,i){CP.OrderModule=function(e){this.isLogin=!1,this.$content=null,this.orderController=null,this.dashboardCallback=e},MYLIB.extend(CP.OrderModule,CP.PopupModule),CP.OrderModule.prototype.firstRender=!1,CP.OrderModule.prototype.init=function(){this.titlePopup='<i class="fa fa-credit-card fa"></i> THANH TOÁN VÀ GỬI ĐƠN HÀNG',this.parent.proto.init.call(this),this.$el.appendTo("body"),this.$content=this.$el.find(".modal-content"),this.firstRender=!0,this.isLogin=this.checkIsLogin(),this.orderController=new CP.OrderController({islogin:this.isLogin},this),this.orderController.init(this.renderViewOrderSuccess.bind(this)),this.$el.on("hide.bs.modal",this.hide.bind(this))},CP.OrderModule.prototype.renderViewOrderSuccess=function(){this.orderController.addListener("RENDER_HINH_THIET_KE",this,"renderImgHinhSanPhamHanlde"),this.$content.append(this.orderController.getElement())},CP.OrderModule.prototype.getElement=function(){return this.$el},CP.OrderModule.prototype.checkIsRender=function(){return this.$el},CP.OrderModule.prototype.checkIsLogin=function(){return!1},CP.OrderModule.prototype.show=function(){this.$el.modal("show"),this.$el.find(".modal-backdrop").height(e(t).height()+1200)},CP.OrderModule.prototype.checkRenderImageThietKe=function(){this.orderController.fireEvent("RENDER_HINH_THIET_KE",!0)},CP.OrderModule.prototype.renderImgHinhSanPhamHanlde=function(){var e=this.dashboardCallback.rightModule.mainCanvas.saveCanvasToImg();if(this.dashboardCallback.rightModule.mainCanvas.hasBack){var t=this.dashboardCallback.rightModule.mainCanvas.saveCanvasBackToImg(),n=this.orderController.checkOutStep1.getImgHinhThietkeMatsau();n.attr("src",t)}if(this.dashboardCallback.rightModule.mainCanvas.hasLayerCircle){var i=this.dashboardCallback.rightModule.mainCanvas.saveLayerCircleCanvasToImg(),a=this.orderController.checkOutStep1.$imgSanpham_layerBack;a.attr("src",i)}var r=this.orderController.checkOutStep1.getImgHinhThietke();r.attr("src",e)},CP.OrderModule.prototype.getSVG=function(){var e=this.dashboardCallback.rightModule.mainCanvas.saveCanvasToSVG();return e},CP.OrderModule.prototype.destroy=function(){this.$el.remove()},CP.OrderModule.prototype.hide=function(){this.destroy(),this.orderController.checkOutStep3.isFinalStep&&(this.$el.modal("hide"),e(t).unbind("beforeunload"),location.reload())},MYLIB.mixin(CP.OrderModule,MYLIB.Event.ObserverMixin)}(jQuery,window,document),function(e,t,n,i){CP.OrderStep1Module=function(e){this.$el=null,this.$btnNext=null,this.$imgSanpham=null,this.$imgSanpham_back=null,this.$imgSanpham_layerBack=null,this.$inputName=null,this.$inputEmail=null,this.$inputPhone=null,this.$inputNote=null,this.$inputSoluong=null,this.viewPath="js/module/order.module.v1/view/step1.html",this.callbackOrderModule=e},CP.OrderStep1Module.prototype.init=function(t){var n=this;e.get(this.viewPath,function(i){var a=e(i).html(),r=Handlebars.compile(a);n.$el=e(r()),n.$btnNext=n.$el.find(".step1-next"),n.$imgSanpham=n.$el.find(".hinh-anh-thiet-ke"),n.$imgSanpham_back=n.$el.find(".hinh-anh-thiet-ke-mat-sau"),n.$imgSanpham_layerBack=n.$el.find(".hinh-anh-thiet-ke-layer-circle"),n.$inputName=n.$el.find(".name"),n.$inputEmail=n.$el.find(".email"),n.$inputPhone=n.$el.find(".phone"),n.$inputNote=n.$el.find(".ghi-chu"),n.$inputSoluong=n.$el.find(".soluong"),n.bindEvent(),t.call(this)})},CP.OrderStep1Module.prototype.getElement=function(){return this.$el},CP.OrderStep1Module.prototype.getImgHinhThietke=function(){return this.$imgSanpham},CP.OrderStep1Module.prototype.getImgHinhThietkeMatsau=function(){return this.$imgSanpham_back},CP.OrderStep1Module.prototype.bindEvent=function(){this.$btnNext.bind("click",this.nextStep2Handle.bind(this))},CP.OrderStep1Module.prototype.show=function(){this.$el.addClass("animated fadeInLeft"),this.$el.removeClass("hidden")},CP.OrderStep1Module.prototype.hide=function(){this.$el.addClass("hidden"),this.$el.removeClass("animated fadeInLeft")},CP.OrderStep1Module.prototype.nextStep2Handle=function(){this.checkValidate()&&this.callbackOrderModule.nextToStep2.call(this.callbackOrderModule)},CP.OrderStep1Module.prototype.checkValidate=function(){var t=this.$inputEmail.val(),n=this.$inputPhone.val(),i=this.$inputName.val(),a=!1,r=!1;isValidateEmail=!1,isValidateSoLuong=!1;var o=this.$inputSoluong.val();return""==e.trim(i)?(this.$inputName.toggleClass("animated swing"),this.$inputName.siblings(".error").html("").html("Xin quý khách vui lòng nhập tên họ!"),a=!1):(this.$inputName.siblings(".error").html(""),a=!0),CP.Validate.checkEmail(t)?(isValidateEmail=!0,this.$inputEmail.siblings(".error").html("")):(this.$inputEmail.toggleClass("animated swing"),this.$inputEmail.siblings(".error").html("").html("Email không hợp lệ"),isValidateEmail=!1),CP.Validate.checkPhone(n,8,11)?(this.$inputPhone.siblings(".error").html(""),r=!0):(this.$inputPhone.toggleClass("animated swing"),this.$inputPhone.siblings(".error").html("").html("Số điện thoại phải từ 8 -> 11 số. Xin quý khách thông cảm, nhập số điện thoại đúng để dễ cho việc giao hàng!"),r=!1),CP.Validate.checkNumber(o,0,10)?(this.$inputSoluong.siblings(".error").html(""),isValidateSoLuong=!0):(this.$inputSoluong.toggleClass("animated swing"),this.$inputSoluong.siblings(".error").html("").html("Xin lỗi, chúng tôi chỉ cung cấp được số lượng từ 1-10 sản phẩm"),isValidateSoLuong=!1),isValidateEmail&&r&&isValidateSoLuong?!0:!1},CP.OrderStep1Module.prototype.getValue=function(){if(this.callbackOrderModule.orderModule.dashboardCallback.rightModule.mainCanvas.is_layerCircle)var e={tenkhachhang:this.$inputName.val(),email:this.$inputEmail.val(),phone:this.$inputPhone.val(),orderNote:this.$inputNote.val(),hinhminhhoa:this.$imgSanpham.attr("src"),hinhminhhoa_back:this.$imgSanpham_back.attr("src"),hinhdein:this.callbackOrderModule.orderModule.dashboardCallback.rightModule.mainCanvas.getImageFrontToPrint(),hinhdein_back:this.callbackOrderModule.orderModule.dashboardCallback.rightModule.mainCanvas.getImageBackToPrint(),hinhdein_layerBack:this.callbackOrderModule.orderModule.dashboardCallback.rightModule.mainCanvas.getImgLayerCircleToPrint(),hinhminhhoa_layerBack:this.$imgSanpham_layerBack.attr("src"),soluong:this.$inputSoluong.val()};else var e={tenkhachhang:this.$inputName.val(),email:this.$inputEmail.val(),phone:this.$inputPhone.val(),orderNote:this.$inputNote.val(),hinhminhhoa:this.$imgSanpham.attr("src"),hinhminhhoa_back:this.$imgSanpham_back.attr("src"),hinhdein:this.callbackOrderModule.orderModule.dashboardCallback.rightModule.mainCanvas.getImageFrontToPrint(),hinhdein_back:this.callbackOrderModule.orderModule.dashboardCallback.rightModule.mainCanvas.getImageBackToPrint(),hinhdein_layerBack:"",hinhminhhoa_layerBack:"",soluong:this.$inputSoluong.val()};return e},MYLIB.mixin(CP.OrderStep1Module,MYLIB.Event.ObserverMixin)}(jQuery,window,document),function(e,t,n,i){CP.OrderStep2Module=function(e){this.$el=null,this.$btnBack=null,this.$btnSubmit=null,this.$howtopay=null,this.$tennguoinhan=null,this.$phonenguoinhan=null,this.$diachigiaohang=null,this.$sharing=null,this.$banking_z=null,this.$banking_account=null,this.$banking_name=null,this.$banking_nd=null,this.viewPath="js/module/order.module.v1/view/step2.html",this.callbackOrderModule=e},CP.OrderStep2Module.prototype.init=function(t){var n=this;e.get(this.viewPath,function(a){var r=e(a).html(),o=Handlebars.compile(r);n.$el=e(o()),n.$btnBack=n.$el.find(".back"),n.$btnSubmit=n.$el.find(".check-out-submit"),n.$howtopay=n.$el.find(".how-to-pay"),n.$tennguoinhan=n.$el.find(".ten-nguoi-nhan"),n.$phonenguoinhan=n.$el.find(".phone_nguoi_nhan"),n.$diachigiaohang=n.$el.find(".dia-chi-giao-hang"),n.$sharing=n.$el.find(".share-member"),n.$banking_z=n.$el.find(".chuyenkhoan-user"),n.$banking_account=n.$banking_z.find(".bankingaccount"),n.$banking_name=n.$banking_z.find(".bankingname"),n.$banking_nd=n.$banking_z.find(".banking_noidung");var h=MYLIB.getParamURL("isAdmin");h!=i&&h||n.$sharing.parent().parent().remove(),n.bindEvent(),t.call(this)})},CP.OrderStep2Module.prototype.show=function(){this.$el.addClass("animated fadeInLeft"),this.$el.removeClass("hidden")},CP.OrderStep2Module.prototype.hide=function(){this.$el.addClass("hidden"),this.$el.removeClass("animated fadeInLeft")},CP.OrderStep2Module.prototype.getElement=function(){return this.$el},CP.OrderStep2Module.prototype.bindEvent=function(){this.$btnBack.bind("click",this.backHandle.bind(this)),this.$btnSubmit.bind("click",this.submitOrderAndNextToStep3.bind(this)),this.$howtopay.change(this.changeHowToPay.bind(this))},CP.OrderStep2Module.prototype.backHandle=function(){this.callbackOrderModule.backHandle.call(this.callbackOrderModule)},CP.OrderStep2Module.prototype.submitOrderAndNextToStep3=function(){this.checkValidate()&&this.callbackOrderModule.submitOrderAndNextToStep3.call(this.callbackOrderModule)},CP.OrderStep2Module.prototype.checkValidate=function(){var t=(this.$diachigiaohang.val(),this.$phonenguoinhan.val()),n=this.$tennguoinhan.val(),i=!1,a=!1;return""==e.trim(n)?(this.$tennguoinhan.toggleClass("animated swing"),this.$tennguoinhan.siblings(".error").html("").html("Xin quý khách vui lòng nhập tên người nhận!"),i=!1):(this.$tennguoinhan.siblings(".error").html(""),i=!0),CP.Validate.checkPhone(t,8,11)?(a=!0,this.$phonenguoinhan.siblings(".error").html("")):(this.$phonenguoinhan.toggleClass("animated swing"),this.$phonenguoinhan.siblings(".error").html("").html("Số điện thoại phải từ 8 -> 11 số. Xin quý khách thông cảm, nhập số điện thoại đúng để dễ cho việc giao hàng!"),a=!1),i&&a?!0:!1},CP.OrderStep2Module.prototype.getValue=function(){var e={phuongthucthanhtoan:this.$howtopay.val(),tennguoinhan:this.$tennguoinhan.val(),phone_nguoinhan:this.$phonenguoinhan.val(),diachinguoinhan:this.$diachigiaohang.val(),is_sharing:this.$sharing.is(":checked")?!0:!1,bank_account:this.$banking_account.val(),bank_name:this.$banking_name.val(),noidung_bank:this.$banking_nd.val(),list_asset_imgs:"",list_facebook_imgs:""};return e},CP.OrderStep2Module.prototype.changeHowToPay=function(){var e=this.$howtopay.val();"Chuyển khoản ngân hàng"===e?(this.$banking_z.removeClass("hidden"),this.$banking_nd.val(this.$tennguoinhan.val())):this.$banking_z.addClass("hidden")},MYLIB.mixin(CP.OrderStep2Module,MYLIB.Event.ObserverMixin)}(jQuery,window,document),function(e,t,n,i){CP.OrderStep3Module=function(e){this.$el=null,this.viewPath="js/module/order.module.v1/view/step3.html",this.$elStatus=null,this.$elStatusMessage=null,this.$elloading=null,this.$shareFacebook=null,this.isFinalStep=!1,this.callbackOrderController=e},CP.OrderStep3Module.prototype.init=function(t){var n=this;e.get(this.viewPath,function(i){var a=e(i).html(),r=Handlebars.compile(a);n.$el=e(r()),n.$elStatus=n.$el.find(".status-order"),n.$elStatusMessage=n.$el.find(".status-order-msg"),n.$elloading=n.$el.find(".loading"),n.$shareFacebook=n.$el.find(".share-fb"),n.orderNow.call(n),n.bindEvent(),n.isFinalStep=!0,t.call(this)})},CP.OrderStep3Module.prototype.show=function(){this.$el.addClass("animated fadeInLeft"),this.$el.removeClass("hidden")},CP.OrderStep3Module.prototype.hide=function(){this.$el.addClass("hidden"),this.$el.removeClass("animated fadeInLeft")},CP.OrderStep3Module.prototype.getElement=function(){return this.$el},CP.OrderStep3Module.prototype.bindEvent=function(){var e=this;this.$shareFacebook.bind("click",function(t){e.callbackOrderController.shareFacebook.call(e.callbackOrderController)})},CP.OrderStep3Module.prototype.backHandle=function(){},CP.OrderStep3Module.prototype.orderNow=function(){this.callbackOrderController.orderNow.call(this.callbackOrderController)},CP.OrderStep3Module.prototype.updateStatus=function(e){this.$elloading.hide(),"fail"==e?(this.$elStatus.text("Có lỗi xãy ra trong quá trình xử lý đơn hàng..."),this.$elStatusMessage.text("Có lỗi xãy ra trong quá trình xử lý đơn hàng, vui lòng tắt popup và thử lại")):"success"==e&&(this.$elStatus.text("Đặt hàng thành công"),this.$elStatusMessage.text("Cảm ơn bạn đã lựa chọn chúng tôi, đơn hàng của bạn đã được xử lý, chúng tôi sẽ liên hệ với bạn trong thời gian ngắn nhất để giao hàng!"))},MYLIB.mixin(CP.OrderStep3Module,MYLIB.Event.ObserverMixin)}(jQuery,window,document);